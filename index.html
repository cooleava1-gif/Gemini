<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æˆ‘çš„åŸºé‡‘å®ç›˜ ğŸš€</title>
    <style>
        /* --- æ ·å¼é…ç½® --- */
        :root { 
            --bg: #0f172a; --card: #1e293b; --text: #e2e8f0; 
            --red: #ef4444; --green: #22c55e; --blue: #3b82f6; 
            --border: rgba(255,255,255,0.1); 
        }
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif; background: var(--bg); color: var(--text); margin: 0; padding: 20px; }
        .container { max-width: 800px; margin: 0 auto; }
        
        /* å¡ç‰‡æ ·å¼ */
        .card { background: var(--card); border-radius: 12px; padding: 20px; margin-bottom: 20px; border: 1px solid var(--border); box-shadow: 0 4px 6px rgba(0,0,0,0.3); }
        h2 { margin-top: 0; font-size: 18px; border-bottom: 1px solid var(--border); padding-bottom: 12px; display: flex; justify-content: space-between; align-items: center; }
        
        /* æ•°æ®æ¦‚è§ˆ */
        .kpi-box { display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px; margin-bottom: 5px; }
        .kpi-item { text-align: center; }
        .kpi-label { font-size: 12px; color: #94a3b8; margin-bottom: 4px; }
        .kpi-val { font-size: 22px; font-weight: bold; }
        
        /* è¾“å…¥æ¡†å’ŒæŒ‰é’® */
        .input-group { display: flex; gap: 8px; flex-wrap: wrap; margin-bottom: 15px; }
        input { background: #334155; border: 1px solid var(--border); color: white; padding: 10px; border-radius: 8px; flex: 1; min-width: 100px; outline: none; }
        input:focus { border-color: var(--blue); }
        button { cursor: pointer; padding: 10px 16px; border-radius: 8px; border: none; font-weight: bold; transition: 0.2s; white-space: nowrap; }
        .btn-add { background: var(--blue); color: white; }
        .btn-add:hover { background: #2563eb; }
        .btn-refresh { font-size: 12px; background: #334155; color: #cbd5e1; padding: 6px 12px; }
        .btn-refresh:hover { background: #475569; }

        /* è¡¨æ ¼ */
        table { width: 100%; border-collapse: collapse; margin-top: 10px; font-size: 14px; }
        th { text-align: left; color: #94a3b8; font-weight: normal; padding: 10px 5px; border-bottom: 1px solid var(--border); font-size: 12px; }
        td { padding: 12px 5px; border-bottom: 1px solid var(--border); vertical-align: middle; }
        
        /* æ¶¨è·Œé¢œè‰² */
        .up { color: var(--red); }
        .down { color: var(--green); }
        .neutral { color: var(--text); }
        
        .del-btn { color: #64748b; cursor: pointer; font-size: 12px; margin-left: 5px; }
        .del-btn:hover { color: var(--red); text-decoration: underline; }
        
        .tag { font-size: 10px; padding: 2px 4px; border-radius: 4px; background: #334155; color: #94a3b8; margin-top: 4px; display: inline-block; }

        /* æ‰‹æœºé€‚é… */
        @media (max-width: 600px) {
            .kpi-box { grid-template-columns: 1fr 1fr; gap: 15px; }
            .kpi-item:last-child { grid-column: span 2; }
            th, thead { display: none; }
            tr { display: flex; flex-direction: column; background: rgba(255,255,255,0.02); padding: 10px; margin-bottom: 10px; border-radius: 8px; }
            td { display: flex; justify-content: space-between; border: none; padding: 4px 0; }
            td::before { content: attr(data-label); color: #94a3b8; font-size: 12px; }
        }
    </style>
</head>
<body>

<div class="container">
    <div class="card">
        <h2>
            <span>ğŸ“ˆ èµ„äº§æ¦‚è§ˆ</span>
            <button class="btn-refresh" onclick="updateAllData()">ğŸ”„ åˆ·æ–°</button>
        </h2>
        <div class="kpi-box">
            <div class="kpi-item">
                <div class="kpi-label">ä»Šæ—¥é¢„ä¼°ç›ˆäº</div>
                <div class="kpi-val" id="day-profit">--</div>
            </div>
            <div class="kpi-item">
                <div class="kpi-label">æŒæœ‰æ”¶ç›Šç‡</div>
                <div class="kpi-val" id="total-rate">--</div>
            </div>
            <div class="kpi-item">
                <div class="kpi-label">æ€»èµ„äº§ (é¢„ä¼°)</div>
                <div class="kpi-val" id="total-asset" style="color:#e2e8f0">--</div>
            </div>
        </div>
        <div style="font-size:10px; color:#64748b; text-align:center; margin-top:10px">
            * æ•°æ®æ¥æºï¼šå¤©å¤©åŸºé‡‘å®æ—¶ä¼°å€¼ (æœ‰å»¶è¿Ÿ)
        </div>
    </div>

    <div class="card">
        <h2>ğŸ“ æ·»åŠ /ä¿®æ”¹æŒä»“</h2>
        <div class="input-group">
            <input type="text" id="in-code" placeholder="ä»£ç  (å¦‚ 110011)">
            <input type="number" id="in-cost" placeholder="æˆæœ¬ä»· (å¦‚ 2.50)">
            <input type="number" id="in-share" placeholder="æŒæœ‰ä»½é¢ (å¦‚ 1000)">
            <button class="btn-add" onclick="addFund()">+ ç¡®è®¤</button>
        </div>
    </div>

    <div class="card">
        <h2>ğŸ“‹ æŒä»“æ˜ç»†</h2>
        <table id="fund-table">
            <thead>
                <tr>
                    <th width="30%">åŸºé‡‘åç§°</th>
                    <th width="15%">ä¼°å€¼æ¶¨è·Œ</th>
                    <th width="20%">æŒæœ‰/å¸‚å€¼</th>
                    <th width="20%">ä»Šæ—¥ç›ˆäº</th>
                    <th width="15%">æ“ä½œ</th>
                </tr>
            </thead>
            <tbody id="table-body"></tbody>
        </table>
    </div>
</div>

<script>
    // --- é€»è¾‘æ§åˆ¶ä¸­å¿ƒ ---

    // 1. è¯»å–æœ¬åœ°å­˜å‚¨çš„æ•°æ®
    let myFunds = JSON.parse(localStorage.getItem('myFunds_v2')) || [];

    // 2. æ ¸å¿ƒä¿®å¤ï¼šä½¿ç”¨ HTTPS è¯·æ±‚æ•°æ®
    function fetchFundData(code) {
        // åˆ›å»ºä¸€ä¸ª script æ ‡ç­¾æ¥è·¨åŸŸåŠ è½½æ•°æ®
        const script = document.createElement('script');
        // ã€å…³é”®ç‚¹ã€‘è¿™é‡Œå¿…é¡»ç”¨ httpsï¼Œä¸”åŠ ä¸€ä¸ªéšæœºæ•°é˜²æ­¢ç¼“å­˜
        script.src = `https://fundgz.1234567.com.cn/js/${code}.js?rt=${Date.now()}`;
        
        // å¦‚æœåŠ è½½å¤±è´¥ï¼ˆæ¯”å¦‚ä»£ç å¡«é”™äº†ï¼‰
        script.onerror = () => {
            console.log("åŠ è½½å¤±è´¥:", code);
            const fund = myFunds.find(f => f.code === code);
            if(fund) {
                fund.name = "âŒ ä»£ç é”™è¯¯æˆ–æ¥å£å¼‚å¸¸";
                fund.gz = 0; fund.rate = 0;
                renderTable(); // åˆ·æ–°æ˜¾ç¤ºé”™è¯¯çŠ¶æ€
            }
            script.remove();
        };
        
        document.body.appendChild(script);
        // åŠ è½½æˆåŠŸåè‡ªåŠ¨ç§»é™¤æ ‡ç­¾ï¼Œä¿æŒé¡µé¢æ•´æ´
        script.onload = () => script.remove();
    }

    // 3. å¤©å¤©åŸºé‡‘çš„å›è°ƒå‡½æ•° (APIè¿”å›çš„æ•°æ®ä¼šè°ƒç”¨è¿™ä¸ªå‡½æ•°)
    window.jsonpgz = function(data) {
        const fund = myFunds.find(f => f.code === data.fundcode);
        if (fund) {
            fund.name = data.name;
            fund.gz = parseFloat(data.gsz);    // å®æ—¶ä¼°å€¼
            fund.rate = parseFloat(data.gszzl);// æ¶¨è·Œå¹…%
            fund.time = data.gztime;           // æ›´æ–°æ—¶é—´
            
            saveToLocal(); // ä¿å­˜æœ€æ–°æ•°æ®
            calcSummary(); // é‡æ–°è®¡ç®—æ€»æ”¶ç›Š
        }
    };

    // 4. æ·»åŠ æˆ–æ›´æ–°åŸºé‡‘
    function addFund() {
        const code = document.getElementById('in-code').value.trim();
        const cost = parseFloat(document.getElementById('in-cost').value);
        const share = parseFloat(document.getElementById('in-share').value);

        if (!code || isNaN(cost) || isNaN(share)) {
            alert("è¯·å®Œæ•´å¡«å†™ä»£ç ã€æˆæœ¬å’Œä»½é¢ (oï¾Ÿvï¾Ÿ)ãƒ");
            return;
        }

        const existing = myFunds.find(f => f.code === code);
        if (existing) {
            if(confirm('è¿™ä¸ªåŸºé‡‘å·²ç»æœ‰äº†ï¼Œè¦æ›´æ–°æˆæœ¬å’Œä»½é¢å—ï¼Ÿ')) {
                existing.cost = cost;
                existing.share = share;
            }
        } else {
            myFunds.push({ code, cost, share, name: 'åŠ è½½ä¸­...', gz: 0, rate: 0 });
        }

        saveToLocal();
        updateAllData();
        
        // æ¸…ç©ºè¾“å…¥æ¡†
        document.getElementById('in-code').value = '';
        document.getElementById('in-cost').value = '';
        document.getElementById('in-share').value = '';
    }

    // 5. åˆ é™¤åŸºé‡‘
    function deleteFund(code) {
        if(confirm('ç¡®å®šä¸å†å…³æ³¨è¿™ä¸ªåŸºé‡‘äº†å—ï¼Ÿ')) {
            myFunds = myFunds.filter(f => f.code !== code);
            saveToLocal();
            renderTable();
            calcSummary();
        }
    }

    // 6. ä¿å­˜åˆ°æµè§ˆå™¨
    function saveToLocal() {
        localStorage.setItem('myFunds_v2', JSON.stringify(myFunds));
        renderTable();
    }

    // 7. æ¸²æŸ“è¡¨æ ¼ (æŠŠæ•°æ®å˜æˆ HTML)
    function renderTable() {
        const tbody = document.getElementById('table-body');
        tbody.innerHTML = '';

        myFunds.forEach(f => {
            const marketValue = f.gz * f.share;
            // ç®€å•ç®—æ³•ï¼šä»Šæ—¥ç›ˆäº â‰ˆ å¸‚å€¼ * æ¶¨è·Œå¹…% (ä»…ä¾›å‚è€ƒ)
            const dayProfit = (marketValue / (1 + f.rate/100)) * (f.rate/100);
            
            const tr = document.createElement('tr');
            tr.innerHTML = `
                <td data-label="åç§°">
                    <div style="font-weight:bold">${f.name}</div>
                    <div class="tag">${f.code}</div>
                </td>
                <td data-label="ä¼°å€¼" class="${f.rate >= 0 ? 'up' : 'down'}">
                    <div>${f.gz.toFixed(4)}</div>
                    <div style="font-size:12px">${f.rate >= 0 ? '+' : ''}${f.rate}%</div>
                </td>
                <td data-label="æŒæœ‰">
                    <div>${f.share}ä»½</div>
                    <div style="color:#94a3b8;font-size:12px">Â¥${marketValue.toFixed(0)}</div>
                </td>
                <td data-label="ä»Šæ—¥ç›ˆäº" class="${dayProfit >= 0 ? 'up' : 'down'}" style="font-weight:bold">
                    ${dayProfit >= 0 ? '+' : ''}${dayProfit.toFixed(1)}
                </td>
                <td data-label="æ“ä½œ">
                    <span class="del-btn" onclick="deleteFund('${f.code}')">åˆ é™¤</span>
                </td>
            `;
            tbody.appendChild(tr);
        });
    }

    // 8. è®¡ç®—é¡¶éƒ¨æ±‡æ€»
    function calcSummary() {
        let totalAsset = 0;
        let totalDayProfit = 0;
        let totalCost = 0;

        myFunds.forEach(f => {
            if (f.gz > 0) {
                const mv = f.gz * f.share;
                // åæ¨æ˜¨æ—¥å¸‚å€¼æ¥è®¡ç®—ä»Šæ—¥ç›ˆäº
                const yesterdayMv = mv / (1 + f.rate/100);
                const profit = mv - yesterdayMv;
                
                totalAsset += mv;
                totalDayProfit += profit;
                totalCost += f.cost * f.share;
            }
        });

        const totalRate = totalCost > 0 ? ((totalAsset - totalCost) / totalCost) * 100 : 0;

        document.getElementById('total-asset').innerText = `Â¥${totalAsset.toFixed(2)}`;
        
        const dayEl = document.getElementById('day-profit');
        dayEl.innerText = `${totalDayProfit >= 0 ? '+' : ''}${totalDayProfit.toFixed(2)}`;
        dayEl.className = `kpi-val ${totalDayProfit >= 0 ? 'up' : 'down'}`;

        const rateEl = document.getElementById('total-rate');
        rateEl.innerText = `${totalRate >= 0 ? '+' : ''}${totalRate.toFixed(2)}%`;
        rateEl.className = `kpi-val ${totalRate >= 0 ? 'up' : 'down'}`;
    }

    // 9. æ‰¹é‡æ›´æ–°
    function updateAllData() {
        myFunds.forEach(fund => fetchFundData(fund.code));
    }

    // --- å¯åŠ¨å¼•æ“ ---
    renderTable(); // å…ˆæ˜¾ç¤ºå·²æœ‰æ•°æ®
    updateAllData(); // ç«‹å³è”ç½‘æ›´æ–°
    
    // æ¯60ç§’è‡ªåŠ¨åˆ·æ–°ä¸€æ¬¡
    setInterval(updateAllData, 60000);

</script>
</body>
</html>
