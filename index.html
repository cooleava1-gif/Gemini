<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ALPHA 基金驾驶舱</title>
    <style>
        /* --- 交易员风格配色 --- */
        :root {
            --bg: #0b0e11;          /* 极深蓝黑背景 */
            --card: #151a21;        /* 模块背景 */
            --border: #2a3441;      /* 边框线 */
            --text-main: #e1e7ef;   /* 主文字 */
            --text-sub: #8492a6;    /* 次要文字 */
            --red: #ff4d4f;         /* 亏损/跌 */
            --green: #00b578;       /* 盈利/涨 */
            --blue: #2979ff;        /* 强调色 */
            --gold: #ffc107;        /* 特殊标记 */
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
            background-color: var(--bg);
            color: var(--text-main);
            margin: 0;
            padding: 10px;
            font-size: 13px; /* 整体字体改小，更紧凑 */
        }

        /* 专用数字字体，像股票软件一样对齐 */
        .num {
            font-family: 'Consolas', 'Monaco', 'Courier New', monospace;
            font-weight: 500;
        }

        .container { max-width: 1200px; margin: 0 auto; }

        /* 顶部统计条 */
        .dashboard-header {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 10px;
            margin-bottom: 15px;
        }
        
        .stat-card {
            background: var(--card);
            border: 1px solid var(--border);
            padding: 15px;
            border-radius: 4px; /* 硬朗的直角圆角 */
            position: relative;
            overflow: hidden;
        }
        
        .stat-card::after {
            content: '';
            position: absolute;
            top: 0; left: 0; width: 3px; height: 100%;
            background: var(--blue);
        }

        .stat-label { color: var(--text-sub); font-size: 12px; margin-bottom: 5px; }
        .stat-val { font-size: 20px; font-weight: bold; letter-spacing: 0.5px; }

        /* 输入区域 */
        .toolbar {
            background: var(--card);
            padding: 15px;
            border: 1px solid var(--border);
            border-radius: 4px;
            margin-bottom: 15px;
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
            align-items: center;
        }

        input {
            background: #000;
            border: 1px solid var(--border);
            color: var(--text-main);
            padding: 8px 10px;
            border-radius: 2px;
            font-family: inherit;
            outline: none;
            flex: 1;
            min-width: 100px;
        }
        input:focus { border-color: var(--blue); }

        button {
            background: var(--blue);
            color: white;
            border: none;
            padding: 8px 20px;
            border-radius: 2px;
            cursor: pointer;
            font-weight: bold;
            font-size: 12px;
            transition: 0.2s;
        }
        button:hover { opacity: 0.9; }
        .btn-refresh { background: #334155; margin-left: auto; }

        /* 核心表格 */
        .table-wrapper {
            overflow-x: auto; /* 允许横向滚动 */
            background: var(--card);
            border: 1px solid var(--border);
            border-radius: 4px;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            white-space: nowrap; /* 强制不换行 */
        }

        th {
            text-align: right; /* 数字靠右对齐 */
            padding: 12px 10px;
            color: var(--text-sub);
            font-weight: normal;
            border-bottom: 1px solid var(--border);
            font-size: 12px;
            cursor: pointer;
        }
        th:first-child { text-align: left; } /* 名称靠左 */

        td {
            padding: 10px 10px;
            text-align: right;
            border-bottom: 1px solid #1f2631;
        }
        td:first-child { text-align: left; }

        /* 颜色工具类 */
        .up-bg { background: rgba(239, 68, 68, 0.15); color: var(--red); padding: 2px 4px; border-radius: 2px; }
        .down-bg { background: rgba(34, 197, 94, 0.15); color: var(--green); padding: 2px 4px; border-radius: 2px; }
        .up { color: var(--red); }
        .down { color: var(--green); }
        .mute { color: var(--text-sub); }

        /* 进度条 */
        .progress-bar-bg {
            width: 60px;
            height: 4px;
            background: #333;
            border-radius: 2px;
            display: inline-block;
            margin-left: 8px;
            vertical-align: middle;
        }
        .progress-bar-fill { height: 100%; background: var(--blue); border-radius: 2px; }

        /* 删除按钮 */
        .del-btn {
            color: #4b5563;
            cursor: pointer;
            font-size: 16px;
            margin-left: 10px;
        }
        .del-btn:hover { color: var(--red); }

        /* 移动端适配 */
        @media (max-width: 768px) {
            .dashboard-header { grid-template-columns: 1fr 1fr; }
            .toolbar { flex-direction: column; align-items: stretch; }
            .btn-refresh { width: 100%; margin-left: 0; margin-top: 10px; }
        }
    </style>
</head>
<body>

<div class="container">
    
    <div class="dashboard-header">
        <div class="stat-card" style="border-left-color: var(--blue);">
            <div class="stat-label">总资产 (Estimated)</div>
            <div class="stat-val num" id="total-asset">--</div>
        </div>
        <div class="stat-card">
            <div class="stat-label">今日预估盈亏</div>
            <div class="stat-val num" id="day-profit">--</div>
        </div>
        <div class="stat-card">
            <div class="stat-label">累计持有收益</div>
            <div class="stat-val num" id="total-profit">--</div>
        </div>
        <div class="stat-card">
            <div class="stat-label">总仓位收益率</div>
            <div class="stat-val num" id="total-yield">--</div>
        </div>
    </div>

    <div class="toolbar">
        <input type="text" id="in-code" placeholder="代码 (如 161226)" style="flex:0.5">
        <input type="number" id="in-cost" placeholder="持仓均价" step="0.0001">
        <input type="number" id="in-share" placeholder="持仓份额">
        <input type="date" id="in-date" title="建仓日期">
        <button onclick="addFund()">+ 加仓</button>
        <button class="btn-refresh" onclick="forceUpdate()">⚡ 刷新行情</button>
    </div>

    <div class="table-wrapper">
        <table id="fund-table">
            <thead>
                <tr>
                    <th style="min-width: 180px;">标的名称 / 代码</th>
                    <th>实时估值</th>
                    <th>估值涨跌</th>
                    <th>昨日净值</th>
                    <th>持仓成本</th>
                    <th>持有占比</th>
                    <th>持有天数</th>
                    <th>持有收益率</th>
                    <th>今日盈亏</th>
                    <th>累计盈亏</th>
                    <th>操作</th>
                </tr>
            </thead>
            <tbody id="table-body">
                </tbody>
        </table>
    </div>
    
    <div style="margin-top: 10px; font-size: 12px; color: #4b5563; text-align: center;">
        * 数据源：天天基金实时估值 | 场内 LOF/ETF 显示为参考 IOPT | 盈亏数据仅供参考
    </div>
</div>

<script>
    /* * 核心逻辑层
     * 增加了：日期计算、昨日净值对比、占比计算
     */

    // 初始化数据
    let myFunds = JSON.parse(localStorage.getItem('alpha_funds')) || [];

    // 格式化数字：货币
    const fmtMoney = (n) => {
        if (isNaN(n)) return "--";
        return "¥" + n.toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
    };

    // 格式化数字：百分比
    const fmtPct = (n) => {
        if (isNaN(n)) return "--";
        const sign = n >= 0 ? "+" : "";
        return sign + n.toFixed(2) + "%";
    };

    // 1. 获取数据 (HTTPS JSONP)
    function fetchFundData(code) {
        const script = document.createElement('script');
        // 加上时间戳防止缓存
        script.src = `https://fundgz.1234567.com.cn/js/${code}.js?rt=${Date.now()}`;
        
        script.onerror = () => {
            // 如果加载失败，标记为错误
            const fund = myFunds.find(f => f.code === code);
            if(fund) {
                fund.name = `[数据异常] ${code}`;
                fund.err = true;
                saveAndRender();
            }
            script.remove();
        };

        document.body.appendChild(script);
        script.onload = () => script.remove();
    }

    // 2. 接收回调
    window.jsonpgz = function(data) {
        const fund = myFunds.find(f => f.code === data.fundcode);
        if (fund) {
            fund.name = data.name;
            fund.gz = parseFloat(data.gsz);         // 实时估值
            fund.rate = parseFloat(data.gszzl);     // 涨跌幅
            fund.yest = parseFloat(data.dwjz);      // 昨日净值 (关键数据)
            fund.updateTime = data.gztime;          // 更新时间
            fund.err = false;
            saveAndRender();
        }
    };

    // 3. 核心计算与渲染
    function saveAndRender() {
        // 保存
        localStorage.setItem('alpha_funds', JSON.stringify(myFunds));

        // 计算总市值，用于算占比
        let totalAsset = 0;
        let totalCost = 0;
        let totalDayProfit = 0;
        let totalAccumProfit = 0;

        myFunds.forEach(f => {
            if (!f.err && f.gz) {
                const mv = f.gz * f.share; // 市值
                totalAsset += mv;
                totalCost += f.cost * f.share;
                
                // 今日盈亏 = (当前估值 - 昨日净值) * 份额
                // 注意：这里用昨日净值算才是最准的“今日浮动”
                const dayP = (f.gz - f.yest) * f.share;
                totalDayProfit += dayP;

                // 累计盈亏 = (当前估值 - 成本) * 份额
                const accP = (f.gz - f.cost) * f.share;
                totalAccumProfit += accP;
            }
        });

        // 更新顶部卡片
        const totalYield = totalCost > 0 ? (totalAccumProfit / totalCost) * 100 : 0;
        
        updateCard('total-asset', fmtMoney(totalAsset), '');
        updateCard('day-profit', fmtMoney(totalDayProfit), totalDayProfit >= 0 ? 'up' : 'down');
        updateCard('total-profit', fmtMoney(totalAccumProfit), totalAccumProfit >= 0 ? 'up' : 'down');
        updateCard('total-yield', fmtPct(totalYield), totalYield >= 0 ? 'up' : 'down');

        // 渲染表格
        const tbody = document.getElementById('table-body');
        tbody.innerHTML = '';

        myFunds.forEach(f => {
            const mv = f.gz ? f.gz * f.share : 0;
            const weight = totalAsset > 0 ? (mv / totalAsset) * 100 : 0;
            
            // 计算持有天数
            let holdDays = "--";
            if(f.buyDate) {
                const start = new Date(f.buyDate);
                const now = new Date();
                const diff = now - start;
                holdDays = Math.floor(diff / (1000 * 60 * 60 * 24)) + "天";
            }

            // 计算单只基金数据
            const dayP = f.gz ? (f.gz - f.yest) * f.share : 0;
            const accP = f.gz ? (f.gz - f.cost) * f.share : 0;
            const accRate = f.gz ? ((f.gz - f.cost) / f.cost) * 100 : 0;

            const tr = document.createElement('tr');
            tr.innerHTML = `
                <td>
                    <div style="font-weight:bold; color:var(--text-main)">${f.name || '--'}</div>
                    <div class="num" style="color:var(--text-sub); font-size:11px;">${f.code}</div>
                </td>
                <td class="num" style="color:var(--blue); font-weight:bold;">${f.gz ? f.gz.toFixed(4) : '--'}</td>
                <td class="num">
                    <span class="${f.rate >= 0 ? 'up-bg' : 'down-bg'}">
                        ${f.rate >= 0 ? '+' : ''}${f.rate}%
                    </span>
                </td>
                <td class="num mute">${f.yest || '--'}</td>
                <td class="num">${f.cost.toFixed(4)}</td>
                <td>
                    <div style="display:flex; align-items:center; justify-content:flex-end;">
                        <span class="num" style="font-size:11px">${weight.toFixed(1)}%</span>
                        <div class="progress-bar-bg"><div class="progress-bar-fill" style="width:${weight}%"></div></div>
                    </div>
                </td>
                <td class="num mute" style="font-size:11px">${holdDays}</td>
                <td class="num ${accRate >= 0 ? 'up' : 'down'}">${fmtPct(accRate)}</td>
                <td class="num ${dayP >= 0 ? 'up' : 'down'}">${fmtMoney(dayP)}</td>
                <td class="num ${accP >= 0 ? 'up' : 'down'}">${fmtMoney(accP)}</td>
                <td><span class="del-btn" onclick="delFund('${f.code}')">×</span></td>
            `;
            tbody.appendChild(tr);
        });
    }

    // 辅助：更新卡片颜色
    function updateCard(id, val, cls) {
        const el = document.getElementById(id);
        el.innerText = val;
        el.className = 'stat-val num ' + cls;
    }

    // 4. 用户交互：添加
    function addFund() {
        const code = document.getElementById('in-code').value.trim();
        const cost = parseFloat(document.getElementById('in-cost').value);
        const share = parseFloat(document.getElementById('in-share').value);
        const buyDate = document.getElementById('in-date').value;

        if (!code || isNaN(cost) || isNaN(share)) {
            alert("请至少填写：代码、成本、份额");
            return;
        }

        const newFund = { 
            code, cost, share, buyDate,
            name: 'Loading...', gz: 0, rate: 0, yest: 0 
        };

        // 检查是否存在，存在则更新
        const idx = myFunds.findIndex(f => f.code === code);
        if (idx > -1) {
            if(confirm('该基金已存在，确认覆盖数据吗？')) {
                myFunds[idx] = { ...myFunds[idx], cost, share, buyDate };
            }
        } else {
            myFunds.push(newFund);
        }

        saveAndRender();
        fetchFundData(code);
        
        // 清理输入框
        document.getElementById('in-code').value = '';
    }

    // 5. 用户交互：删除
    function delFund(code) {
        if(confirm('确认删除?')) {
            myFunds = myFunds.filter(f => f.code !== code);
            saveAndRender();
        }
    }

    // 6. 强制刷新
    function forceUpdate() {
        myFunds.forEach(f => fetchFundData(f.code));
    }

    // 启动
    forceUpdate();
    setInterval(forceUpdate, 30000); // 30秒刷新一次

</script>
</body>
</html>
