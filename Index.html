<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æˆ‘çš„åŸºé‡‘å®ç›˜ (GitHubç‰ˆ)</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        /* --- æ ·å¼éƒ¨åˆ†ï¼šæ·±è‰²èµ›åšé£ --- */
        :root {
            --bg: #0f172a; --card: #1e293b; --text: #e2e8f0;
            --red: #ef4444; --green: #22c55e; --blue: #3b82f6;
            --border: rgba(255,255,255,0.1);
        }
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif; background: var(--bg); color: var(--text); margin: 0; padding: 20px; }
        .container { max-width: 1000px; margin: 0 auto; }
        
        /* å¡ç‰‡é€šç”¨æ ·å¼ */
        .card { background: var(--card); border-radius: 12px; padding: 20px; margin-bottom: 20px; border: 1px solid var(--border); box-shadow: 0 4px 6px rgba(0,0,0,0.3); }
        h2 { margin-top: 0; font-size: 18px; border-bottom: 1px solid var(--border); padding-bottom: 10px; }
        
        /* é¡¶éƒ¨æ¦‚è§ˆ */
        .summary-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 15px; }
        .kpi .label { font-size: 12px; color: #94a3b8; }
        .kpi .value { font-size: 24px; font-weight: bold; margin-top: 5px; }
        
        /* è¾“å…¥åŒºåŸŸ */
        .input-group { display: flex; gap: 10px; flex-wrap: wrap; align-items: end; }
        input { background: #334155; border: 1px solid var(--border); color: white; padding: 10px; border-radius: 8px; flex: 1; min-width: 120px; }
        button { cursor: pointer; padding: 10px 20px; border-radius: 8px; border: none; font-weight: bold; transition: 0.2s; }
        .btn-add { background: var(--blue); color: white; }
        .btn-add:hover { background: #2563eb; }
        .btn-refresh { background: #475569; color: white; margin-left: auto; }

        /* è¡¨æ ¼æ ·å¼ */
        table { width: 100%; border-collapse: collapse; margin-top: 10px; font-size: 14px; }
        th { text-align: left; color: #94a3b8; padding: 10px 5px; font-weight: normal; font-size: 12px; }
        td { padding: 12px 5px; border-top: 1px solid var(--border); }
        .up { color: var(--red); }
        .down { color: var(--green); }
        .del-btn { color: #94a3b8; cursor: pointer; font-size: 12px; }
        .del-btn:hover { color: var(--red); text-decoration: underline; }

        /* ç§»åŠ¨ç«¯é€‚é… */
        @media (max-width: 600px) {
            .summary-grid { grid-template-columns: 1fr; }
            .input-group { flex-direction: column; }
            input { width: 100%; box-sizing: border-box; }
            td, th { display: block; text-align: right; }
            td::before { content: attr(data-label); float: left; color: #94a3b8; }
            thead { display: none; }
            tr { display: block; margin-bottom: 15px; border: 1px solid var(--border); padding: 10px; border-radius: 8px; }
        }
    </style>
</head>
<body>

<div class="container">
    <div class="card">
        <div style="display:flex; align-items:center;">
            <h2>ğŸ“Š èµ„äº§æ¦‚è§ˆ</h2>
            <button class="btn-refresh" onclick="updateAllData()">ğŸ”„ åˆ·æ–°æ•°æ®</button>
        </div>
        <div class="summary-grid">
            <div class="kpi">
                <div class="label">é¢„ä¼°æ€»èµ„äº§</div>
                <div class="value" id="total-asset">0.00</div>
            </div>
            <div class="kpi">
                <div class="label">ä»Šæ—¥é¢„ä¼°ç›ˆäº</div>
                <div class="value" id="day-profit">0.00</div>
            </div>
            <div class="kpi">
                <div class="label">æŒæœ‰æ”¶ç›Šç‡</div>
                <div class="value" id="total-rate">0.00%</div>
            </div>
        </div>
        <div style="margin-top: 10px; font-size: 12px; color: #64748b;">
            * æ•°æ®æ¥æºï¼šå¤©å¤©åŸºé‡‘ä¼°å€¼æ¥å£ (ä¼šæœ‰å‡ åˆ†é’Ÿå»¶è¿Ÿ)
        </div>
    </div>

    <div class="card">
        <h2>ğŸ“ æŒä»“ç®¡ç†</h2>
        <div class="input-group">
            <input type="text" id="in-code" placeholder="åŸºé‡‘ä»£ç  (å¦‚ 110011)">
            <input type="number" id="in-cost" placeholder="æŒä»“æˆæœ¬ä»·">
            <input type="number" id="in-share" placeholder="æŒæœ‰ä»½é¢">
            <button class="btn-add" onclick="addFund()">+ æ·»åŠ æŒä»“</button>
        </div>
    </div>

    <div class="card">
        <h2>ğŸ“‹ æŒä»“æ˜ç»†</h2>
        <table id="fund-table">
            <thead>
                <tr>
                    <th>åŸºé‡‘åç§°</th>
                    <th>ä¼°å€¼/å‡€å€¼</th>
                    <th>ä¼°ç®—æ¶¨è·Œ</th>
                    <th>æŒæœ‰ä»½é¢</th>
                    <th>é¢„ä¼°å¸‚å€¼</th>
                    <th>ä»Šæ—¥ç›ˆäº</th>
                    <th>æ“ä½œ</th>
                </tr>
            </thead>
            <tbody id="table-body">
                </tbody>
        </table>
    </div>
</div>

<script>
    // --- æ ¸å¿ƒé€»è¾‘éƒ¨åˆ† ---

    // 1. æ•°æ®å­˜å– (ä½¿ç”¨ LocalStorage)
    let myFunds = JSON.parse(localStorage.getItem('myFunds')) || [];

    function saveToLocal() {
        localStorage.setItem('myFunds', JSON.stringify(myFunds));
        renderTable();
        calcSummary();
    }

    // 2. æ·»åŠ åŸºé‡‘
    function addFund() {
        const code = document.getElementById('in-code').value.trim();
        const cost = parseFloat(document.getElementById('in-cost').value);
        const share = parseFloat(document.getElementById('in-share').value);

        if (!code || isNaN(cost) || isNaN(share)) {
            alert("è¯·å®Œæ•´å¡«å†™ä¿¡æ¯ï¼");
            return;
        }

        // æ£€æŸ¥æ˜¯å¦å·²å­˜åœ¨
        const exists = myFunds.find(f => f.code === code);
        if (exists) {
            if(confirm('è¯¥åŸºé‡‘å·²å­˜åœ¨ï¼Œè¦æ›´æ–°æŒä»“æ•°æ®å—ï¼Ÿ')) {
                exists.cost = cost;
                exists.share = share;
            }
        } else {
            myFunds.push({ 
                code, cost, share, 
                name: 'åŠ è½½ä¸­...', 
                gz: 0, // ä¼°å€¼
                rate: 0 // æ¶¨è·Œå¹…
            });
        }
        
        saveToLocal();
        updateAllData(); // ç«‹å³å»æŠ“æ•°æ®
        
        // æ¸…ç©ºè¾“å…¥æ¡†
        document.getElementById('in-code').value = '';
        document.getElementById('in-cost').value = '';
        document.getElementById('in-share').value = '';
    }

    // 3. åˆ é™¤åŸºé‡‘
    function deleteFund(code) {
        if(confirm('ç¡®å®šåˆ é™¤å—ï¼Ÿ')) {
            myFunds = myFunds.filter(f => f.code !== code);
            saveToLocal();
        }
    }

    // 4. æ ¸å¿ƒï¼šJSONP è·å–å¤©å¤©åŸºé‡‘æ•°æ®
    // æŠ€å·§ï¼šæˆ‘ä»¬åˆ›å»ºä¸€ä¸ª <script> æ ‡ç­¾å»åŠ è½½æ•°æ®ï¼Œç»•è¿‡è·¨åŸŸé™åˆ¶
    function fetchFundData(code) {
        return new Promise((resolve, reject) => {
            const script = document.createElement('script');
            // å¤©å¤©åŸºé‡‘æ¥å£ï¼šhttp://fundgz.1234567.com.cn/js/CODE.js
            script.src = `http://fundgz.1234567.com.cn/js/${code}.js?rt=${Date.now()}`;
            script.onerror = () => {
                console.error(`åŠ è½½å¤±è´¥: ${code}`);
                // åŠ è½½å¤±è´¥æ—¶ç»™ä¸ªé»˜è®¤å€¼
                window.jsonpgz({ fundcode: code, name: "åŠ è½½å¤±è´¥", gsz: "0", gszzl: "0" });
                script.remove();
            };
            document.body.appendChild(script);
            
            // ç¨åç§»é™¤ script æ ‡ç­¾ï¼Œä¿æŒé¡µé¢å¹²å‡€
            script.onload = () => script.remove();
        });
    }

    // 5. å¤©å¤©åŸºé‡‘çš„å›è°ƒå‡½æ•° (å¿…é¡»å«è¿™ä¸ªåå­—)
    // æ¥å£è¿”å›çš„æ•°æ®æ ¼å¼æ˜¯ï¼šjsonpgz({...æ•°æ®...});
    window.jsonpgz = function(data) {
        const fund = myFunds.find(f => f.code === data.fundcode);
        if (fund) {
            fund.name = data.name;
            fund.gz = parseFloat(data.gsz); // ä¼°ç®—å‡€å€¼
            fund.rate = parseFloat(data.gszzl); // ä¼°ç®—æ¶¨è·Œå¹…
            saveToLocal(); // æ›´æ–°å®Œä¿å­˜
        }
    };

    // 6. æ‰¹é‡æ›´æ–°æ‰€æœ‰æ•°æ®
    function updateAllData() {
        myFunds.forEach(fund => {
            fetchFundData(fund.code);
        });
    }

    // 7. æ¸²æŸ“è¡¨æ ¼
    function renderTable() {
        const tbody = document.getElementById('table-body');
        tbody.innerHTML = '';

        myFunds.forEach(f => {
            const marketValue = f.gz * f.share; // å¸‚å€¼
            const dayProfit = (f.gz * f.rate / 100) * f.share; // ç²—ç•¥ä¼°ç®—ä»Šæ—¥ç›ˆäºï¼šå¸‚å€¼ * æ¶¨è·Œå¹…
            // æ³¨æ„ï¼šè¿™é‡Œç®—ä»Šæ—¥ç›ˆäºå¦‚æœç”¨ (ç°ä»·-æ˜¨æ”¶)*ä»½é¢ ä¼šæ›´å‡†ï¼Œä½†æ¥å£ç›´æ¥ç»™äº†æ¶¨è·Œå¹…ï¼Œç›´æ¥ç”¨æ¶¨è·Œå¹…ç®—æ–¹ä¾¿ç‚¹
            // æ›´ç²¾å‡†é€»è¾‘ï¼šä»Šæ—¥ç›ˆäº = (ä¼°å€¼ - ä¼°å€¼/(1+æ¶¨è·Œå¹…%)) * ä»½é¢

            const realDayProfit = marketValue - (marketValue / (1 + f.rate/100));

            const tr = document.createElement('tr');
            tr.innerHTML = `
                <td data-label="åç§°"><b>${f.name}</b><br><span style="color:#64748b;font-size:12px">${f.code}</span></td>
                <td data-label="ä¼°å€¼">${f.gz.toFixed(4)}</td>
                <td data-label="æ¶¨è·Œ" class="${f.rate >= 0 ? 'up' : 'down'}">${f.rate >= 0 ? '+' : ''}${f.rate}%</td>
                <td data-label="ä»½é¢">${f.share}</td>
                <td data-label="å¸‚å€¼">Â¥${marketValue.toFixed(2)}</td>
                <td data-label="ä»Šæ—¥ç›ˆäº" class="${f.rate >= 0 ? 'up' : 'down'}">${realDayProfit.toFixed(2)}</td>
                <td data-label="æ“ä½œ"><span class="del-btn" onclick="deleteFund('${f.code}')">åˆ é™¤</span></td>
            `;
            tbody.appendChild(tr);
        });
    }

    // 8. è®¡ç®—æ€»èµ„äº§
    function calcSummary() {
        let totalAsset = 0;
        let totalDayProfit = 0;
        let totalCost = 0;

        myFunds.forEach(f => {
            if (f.gz > 0) {
                const mv = f.gz * f.share;
                const profit = mv - (mv / (1 + f.rate/100));
                
                totalAsset += mv;
                totalDayProfit += profit;
                totalCost += f.cost * f.share;
            }
        });

        const totalRate = totalCost > 0 ? ((totalAsset - totalCost) / totalCost) * 100 : 0;

        document.getElementById('total-asset').innerText = `Â¥${totalAsset.toFixed(2)}`;
        
        const dayEl = document.getElementById('day-profit');
        dayEl.innerText = `${totalDayProfit >= 0 ? '+' : ''}${totalDayProfit.toFixed(2)}`;
        dayEl.className = `value ${totalDayProfit >= 0 ? 'up' : 'down'}`;

        const rateEl = document.getElementById('total-rate');
        rateEl.innerText = `${totalRate >= 0 ? '+' : ''}${totalRate.toFixed(2)}%`;
        rateEl.className = `value ${totalRate >= 0 ? 'up' : 'down'}`;
    }

    // å¯åŠ¨æ—¶åŠ è½½æ•°æ®
    renderTable();
    updateAllData();
    
    // æ¯60ç§’è‡ªåŠ¨åˆ·æ–°ä¸€æ¬¡
    setInterval(updateAllData, 60000);

</script>
</body>
</html>
